<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oya â€” Group Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f9f8f5;
  --white: #ffffff;
  --ink: #141412;
  --ink-mid: #4a4a42;
  --ink-light: #8a8a7e;
  --ink-faint: #e8e6e0;
  --amber: #b86a00;
  --amber-light: #fdf3e3;
  --red: #9b2b1a;
  --red-light: #fdf0ee;
  --border: #e4e2db;
  --country-color: #1c5c38;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--ink); min-height:100vh; }

/* TOPBAR */
.topbar { background:var(--country-color); padding:0 2.5rem; height:56px; display:flex; align-items:center; justify-content:space-between; transition:background 0.3s; }
.topbar-left { display:flex; align-items:center; gap:1.5rem; }
.brand { font-family:'Libre Baskerville',serif; font-size:1.15rem; color:white; letter-spacing:0.04em; }
.country-tag { background:rgba(255,255,255,0.15); color:rgba(255,255,255,0.9); font-size:0.72rem; padding:3px 12px; border-radius:20px; letter-spacing:0.06em; text-transform:uppercase; }
.topbar-right { font-size:0.72rem; color:rgba(255,255,255,0.6); letter-spacing:0.04em; }
.topbar-right span { color:rgba(255,255,255,0.9); }

/* NAV */
.page-nav { background:var(--white); border-bottom:1px solid var(--border); padding:0 2.5rem; display:flex; align-items:stretch; height:44px; overflow-x:auto; }
.page-nav::-webkit-scrollbar { display:none; }
.nav-tab { display:flex; align-items:center; gap:6px; padding:0 18px; font-family:'DM Sans',sans-serif; font-size:0.78rem; font-weight:500; border:none; background:transparent; cursor:pointer; color:var(--ink-light); border-bottom:2px solid transparent; white-space:nowrap; transition:color .15s,border-color .15s; }
.nav-tab:hover { color:var(--ink); }
.nav-tab.active { color:var(--ink); border-bottom-color:var(--country-color); }
.nav-dot { width:6px; height:6px; border-radius:50%; display:inline-block; flex-shrink:0; background:var(--country-color); }

/* PERIOD BAR */
.period-bar { background:var(--white); border-bottom:1px solid var(--border); padding:0 2.5rem; height:44px; display:flex; align-items:center; justify-content:space-between; }
.period-label { font-size:0.72rem; color:var(--ink-light); text-transform:uppercase; letter-spacing:0.07em; }
.period-label strong { color:var(--ink); font-weight:500; }
.data-note { font-size:0.68rem; color:var(--ink-light); font-style:italic; }
.toggle-btn { padding:5px 16px; border-radius:6px; border:none; background:transparent; font-family:'DM Sans',sans-serif; font-size:0.78rem; cursor:pointer; color:var(--ink-light); transition:all .15s; font-weight:500; }
.toggle-btn.active { background:var(--white); color:var(--ink); box-shadow:0 1px 3px rgba(0,0,0,.1); }

/* MAIN */
main { padding:2rem 2.5rem; max-width:1400px; margin:0 auto; }
.section-label { font-size:0.65rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--ink-light); margin-bottom:0.75rem; margin-top:1.75rem; }
.section-label:first-child { margin-top:0; }

/* KPI */
.kpi-strip { display:grid; grid-template-columns:repeat(5,1fr); gap:1px; background:var(--border); border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:0.25rem; }
.kpi { background:var(--white); padding:1.25rem 1.4rem; opacity:0; animation:fadeUp 0.4s ease forwards; }
.kpi:nth-child(1){animation-delay:.05s}.kpi:nth-child(2){animation-delay:.10s}.kpi:nth-child(3){animation-delay:.15s}.kpi:nth-child(4){animation-delay:.20s}.kpi:nth-child(5){animation-delay:.25s}
.kpi-label { font-size:0.65rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--ink-light); margin-bottom:0.6rem; }
.kpi-val { font-family:'Libre Baskerville',serif; font-size:1.75rem; font-weight:400; line-height:1; margin-bottom:0.4rem; letter-spacing:-0.02em; }
.kpi-sub { font-size:0.7rem; color:var(--ink-light); }

/* LAYOUT */
.two-col { display:grid; grid-template-columns:1fr 1fr; gap:1.25rem; }
.three-col { display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.25rem; }
.card { background:var(--white); border:1px solid var(--border); border-radius:12px; padding:1.4rem 1.5rem; opacity:0; animation:fadeUp 0.5s ease forwards; }
.card:nth-child(1){animation-delay:.3s}.card:nth-child(2){animation-delay:.38s}.card:nth-child(3){animation-delay:.46s}
.card-title { font-family:'Libre Baskerville',serif; font-size:0.92rem; font-weight:400; margin-bottom:0.3rem; }
.card-sub { font-size:0.68rem; color:var(--ink-light); margin-bottom:1.25rem; }

/* FUNNEL */
.funnel { display:flex; flex-direction:column; gap:5px; }
.f-row { display:flex; align-items:center; gap:10px; }
.f-label { font-size:0.72rem; color:var(--ink-mid); width:88px; flex-shrink:0; text-align:right; }
.f-track { flex:1; height:32px; background:var(--ink-faint); border-radius:5px; overflow:hidden; }
.f-fill { height:100%; border-radius:5px; display:flex; align-items:center; padding:0 10px; font-size:0.75rem; font-weight:500; color:white; white-space:nowrap; transition:width 0.8s cubic-bezier(0.16,1,0.3,1); }
.f-pct { font-size:0.72rem; width:44px; text-align:right; color:var(--ink-light); flex-shrink:0; }

/* GAUGES */
.gauge-wrap { display:flex; flex-direction:column; gap:1.5rem; }
.gauge-header { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:0.5rem; }
.gauge-name { font-size:0.78rem; font-weight:500; }
.gauge-pct { font-family:'Libre Baskerville',serif; font-size:1.4rem; font-weight:400; }
.gauge-track { height:8px; background:var(--ink-faint); border-radius:4px; overflow:hidden; margin-bottom:0.35rem; }
.gauge-fill { height:100%; border-radius:4px; transition:width 1s cubic-bezier(0.16,1,0.3,1); }
.gauge-detail { font-size:0.67rem; color:var(--ink-light); }

/* TABLE */
.vol-table { width:100%; border-collapse:collapse; }
.vol-table tr td { padding:0.55rem 0; font-size:0.82rem; border-bottom:1px solid var(--ink-faint); }
.vol-table tr:last-child td { border-bottom:none; }
.vol-table td:last-child { text-align:right; font-weight:500; }
.vol-table tr.total td { font-weight:600; border-top:2px solid var(--border); border-bottom:none; padding-top:0.75rem; font-size:0.86rem; }
.vol-table .row-label { color:var(--ink-mid); }
.vol-table .row-sub { font-size:0.65rem; color:var(--ink-light); display:block; }
.pos { color:var(--country-color); }
.neg { color:var(--red); }

/* CHRONIC */
.chronic-split { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem; }
.chronic-cell { background:var(--bg); border-radius:8px; padding:1rem; }
.chronic-cell-label { font-size:0.65rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--ink-light); margin-bottom:0.4rem; }
.chronic-cell-val { font-family:'Libre Baskerville',serif; font-size:1.2rem; }

/* FOOTER */
.footer-note { margin-top:2rem; padding-top:1.25rem; border-top:1px solid var(--border); font-size:0.65rem; color:var(--ink-light); display:flex; justify-content:space-between; }

@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

/* HBAR */
.hbar-chart { display:flex; flex-direction:column; gap:12px; }
.hbar-row { display:flex; flex-direction:column; gap:4px; }
.hbar-header { display:flex; justify-content:space-between; align-items:center; }
.hbar-country { font-size:0.75rem; color:var(--ink-mid); }
.hbar-val { font-size:0.75rem; font-weight:500; }
.hbar-track { height:10px; background:var(--ink-faint); border-radius:5px; overflow:hidden; }
.hbar-fill { height:100%; border-radius:5px; transition:width 0.9s cubic-bezier(0.16,1,0.3,1); }

/* GAUGE COUNTRY */
.gauge-country-block { margin-bottom:1rem; }
.gauge-country-block:last-child { margin-bottom:0; }
.gauge-country-name { font-size:0.72rem; font-weight:500; margin-bottom:6px; }
.gauge-pair { display:flex; gap:1rem; }
.gauge-lbl { font-size:0.65rem; color:var(--ink-light); }
.gauge-pct-sm { font-family:'Libre Baskerville',serif; font-size:1rem; }
.threshold-legend { display:flex; gap:12px; font-size:0.65rem; color:var(--ink-light); margin-bottom:1rem; padding-bottom:0.75rem; border-bottom:1px solid var(--ink-faint); }
.threshold-legend span { display:flex; align-items:center; gap:4px; }
.swatch { width:10px; height:10px; border-radius:2px; display:inline-block; }

/* KPI GRID 2x3 */
.kpi-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1px; background:var(--border); border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:0.25rem; }
@media(max-width:1100px){.kpi-strip{grid-template-columns:repeat(3,1fr)}}
@media(max-width:900px){.two-col,.three-col{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="topbar" id="topbar">
  <div class="topbar-left">
    <div class="brand">Oya</div>
    <div class="country-tag" id="country-tag">ðŸ‡¹ðŸ‡¿ Tanzania</div>
  </div>
  <div class="topbar-right" id="topbar-right">
    As of <span id="hdr-date">â€”</span> &nbsp;Â·&nbsp; All figures in <span>USD</span> &nbsp;Â·&nbsp; Rate: <span id="hdr-rate">â€”</span>
  </div>
</div>

<div class="page-nav">
  <button class="nav-tab" id="nav-group" onclick="switchCountry('GROUP')">ðŸ—º Group Overview</button>
  <button class="nav-tab" id="nav-tz" onclick="switchCountry('TZ')"><span class="nav-dot" id="dot-TZ"></span> ðŸ‡¹ðŸ‡¿ Tanzania</button>
  <button class="nav-tab" id="nav-ke" onclick="switchCountry('KE')"><span class="nav-dot" id="dot-KE"></span> ðŸ‡°ðŸ‡ª Kenya</button>
  <button class="nav-tab" id="nav-ug" onclick="switchCountry('UG')"><span class="nav-dot" id="dot-UG"></span> ðŸ‡ºðŸ‡¬ Uganda</button>
  <button class="nav-tab" id="nav-sl" onclick="switchCountry('SL')"><span class="nav-dot" id="dot-SL"></span> ðŸ‡¸ðŸ‡± Sierra Leone</button>
  <button class="nav-tab" id="nav-ng" onclick="switchCountry('NG')"><span class="nav-dot" id="dot-NG"></span> ðŸ‡³ðŸ‡¬ Nigeria</button>
</div>

<div class="period-bar">
  <div style="display:flex;align-items:center;gap:1rem">
    <div class="period-label" id="period-label">Loading...</div>
  </div>
  <div style="display:flex;align-items:center;gap:1rem">
    <div style="display:flex;align-items:center;gap:6px">
      <label style="font-size:0.68rem;color:var(--ink-light);text-transform:uppercase;letter-spacing:0.07em">Report date</label>
      <select id="report-date-input" onchange="onDateChange(this.value)"
        style="font-family:'DM Sans',sans-serif;font-size:0.78rem;border:1px solid var(--border);border-radius:6px;padding:4px 8px;background:white;color:var(--ink);cursor:pointer;outline:none;">
        <option value="2026-02-25">Feb 25, 2026</option>
      </select>
    </div>
    <div style="display:flex;background:#f3f4f6;border-radius:8px;padding:3px;gap:2px">
      <button class="toggle-btn" id="btn-week" onclick="setView('week')">Week</button>
      <button class="toggle-btn active" id="btn-mtd" onclick="setView('mtd')">MTD</button>
      <button class="toggle-btn" id="btn-ytd" onclick="setView('ytd')">YTD</button>
    </div>
    <div class="data-note" id="data-source-note">Loading...</div>
  </div>
</div>

<div id="country-view">
<main>
  <!-- KPI STRIP -->
  <div class="section-label">Key Metrics</div>
  <div class="kpi-strip" style="grid-template-columns:repeat(3,1fr);margin-bottom:1px">
    <div class="kpi">
      <div class="kpi-label">Applications</div>
      <div class="kpi-val" id="kpi-apps">â€”</div>
      <div class="kpi-sub" id="kpi-apps-sub">â€”</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Assessment Efficiency</div>
      <div class="kpi-val" id="kpi-approval">â€”</div>
      <div class="kpi-sub" id="kpi-approval-sub">â€”</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Principal Disbursed</div>
      <div class="kpi-val" id="kpi-principal">â€”</div>
      <div class="kpi-sub" id="kpi-principal-sub">â€”</div>
    </div>
  </div>
  <div class="kpi-strip" style="grid-template-columns:repeat(3,1fr)">
    <div class="kpi" style="border-top:3px solid var(--country-color)">
      <div class="kpi-label">Total Revenue</div>
      <div class="kpi-val" id="kpi-revenue" style="color:var(--country-color)">â€”</div>
      <div class="kpi-sub" id="kpi-revenue-sub">â€”</div>
    </div>
    <div class="kpi" style="border-top:3px solid var(--amber)">
      <div class="kpi-label">PAR 30</div>
      <div class="kpi-val" id="kpi-par30" style="color:var(--amber)">â€”</div>
      <div class="kpi-sub" id="kpi-par30-sub">â€”</div>
    </div>
    <div class="kpi" style="border-top:3px solid var(--amber)">
      <div class="kpi-label">Chronic Rate (YTD)</div>
      <div class="kpi-val" id="kpi-chronic" style="color:var(--amber)">â€”</div>
      <div class="kpi-sub" id="kpi-chronic-sub">YTD vs Jan 1 baseline</div>
    </div>
  </div>

  <!-- REVENUE -->
  <div class="section-label">Revenue</div>
  <div class="kpi-strip" style="grid-template-columns:repeat(3,1fr);margin-bottom:1.5rem">
    <div class="kpi">
      <div class="kpi-label">Interest Income (Cash)</div>
      <div class="kpi-val" id="rev-interest">â€”</div>
      <div class="kpi-sub" id="rev-interest-sub">â€”</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Processing Fees</div>
      <div class="kpi-val" id="rev-fees">â€”</div>
      <div class="kpi-sub" id="rev-fees-sub">â€”</div>
    </div>
    <div class="kpi" style="border-top:3px solid var(--country-color)">
      <div class="kpi-label">Total Revenue</div>
      <div class="kpi-val" id="rev-total" style="color:var(--country-color)">â€”</div>
      <div class="kpi-sub" id="rev-total-sub">â€”</div>
    </div>
  </div>

  <!-- PIPELINE -->
  <div class="section-label">Loan Pipeline & Disbursement</div>
  <div class="two-col">
    <div class="card">
      <div class="card-title">Application Funnel</div>
      <div class="card-sub" id="f-sub">â€”</div>
      <div class="funnel">
        <div class="f-row">
          <div class="f-label">Applications</div>
          <div class="f-track"><div class="f-fill" id="f-apps-bar" style="width:100%;background:var(--country-color)"><span id="f-apps-val">â€”</span></div></div>
          <div class="f-pct" id="f-apps-pct">100%</div>
        </div>
        <div class="f-row">
          <div class="f-label">Approvals</div>
          <div class="f-track"><div class="f-fill" id="f-apr-bar" style="width:0%;background:#48a87e"><span id="f-apr-val">â€”</span></div></div>
          <div class="f-pct" id="f-apr-pct">â€”</div>
        </div>
        <div class="f-row">
          <div class="f-label">Disbursed</div>
          <div class="f-track"><div class="f-fill" id="f-disb-bar" style="width:0%;background:#6dbf9a"><span id="f-disb-val">â€”</span></div></div>
          <div class="f-pct" id="f-disb-pct">â€”</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Disbursement Breakdown</div>
      <div class="card-sub" id="disb-sub">â€”</div>
      <table class="vol-table">
        <tr><td class="row-label">Loans disbursed</td><td id="d-count">â€”</td></tr>
        <tr><td class="row-label">Total principal<span class="row-sub">Amount lent to customers</span></td><td class="pos" id="d-principal">â€”</td></tr>
        <tr><td class="row-label">Total interest due<span class="row-sub">Gross interest on disbursed loans</span></td><td id="d-interest">â€”</td></tr>
        <tr><td class="row-label">Total P+I<span class="row-sub">Principal + interest</span></td><td id="d-pi">â€”</td></tr>
        <tr><td class="row-label">Fees collected<span class="row-sub">Upfront processing fees</span></td><td id="d-fees">â€”</td></tr>
        <tr><td class="row-label">Avg loan size</td><td id="d-avg">â€”</td></tr>
        <tr class="total"><td>Total revenue potential<span class="row-sub">Interest + fees</span></td><td class="pos" id="d-rev">â€”</td></tr>
      </table>
    </div>
  </div>

  <!-- DEFAULTS -->
  <div class="section-label">Default Metrics</div>
  <div class="two-col">
    <div class="card">
      <div class="card-title">PAR 30</div>
      <div class="card-sub">Portfolio at risk &gt; 30 days overdue</div>
      <div class="gauge-wrap">
        <div class="gauge-item">
          <div class="gauge-header">
            <div class="gauge-name">PAR 30 Rate</div>
            <div class="gauge-pct" id="g-par30">â€”</div>
          </div>
          <div class="gauge-track">
            <div class="gauge-fill" id="g-par30-bar" style="width:0%"></div>
          </div>
          <div class="gauge-detail">Cohort: loans disbursed 2â€“9 months before report date &nbsp;Â·&nbsp; Scale: 0â€“30%</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Chronic Rate</div>
      <div class="card-sub">YTD growth in chronic balance vs Jan 1 baseline</div>
      <div class="gauge-wrap">
        <div class="gauge-item">
          <div class="gauge-header">
            <div class="gauge-name">Chronic Rate (YTD)</div>
            <div class="gauge-pct" id="g-chronic">â€”</div>
          </div>
          <div class="gauge-track">
            <div class="gauge-fill" id="g-chronic-bar" style="width:0%"></div>
          </div>
          <div class="gauge-detail">New chronic YTD vs denominator cohort &nbsp;Â·&nbsp; Scale: 0â€“30%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-note">
    <span id="footer-left">Oya Microcredit &nbsp;Â·&nbsp; Proviso Cloud &nbsp;Â·&nbsp; Report totals</span>
    <span id="footer-right">Loan term: 84 days / 12 weekly instalments &nbsp;Â·&nbsp; Chronic threshold: 50 days post-expiry</span>
  </div>
</main>
</div>

<!-- CONSOLIDATED VIEW -->
<div id="consolidated-view" style="display:none">
<main>
  <div class="section-label" id="g-section-label">Group Totals</div>
  <div class="kpi-grid">
    <div class="kpi">
      <div class="kpi-label">Applications</div>
      <div class="kpi-val" id="g-apps">â€”</div>
      <div class="kpi-sub" id="g-apps-sub">â€”</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Assessment Efficiency</div>
      <div class="kpi-val" id="g-assessment">â€”</div>
      <div class="kpi-sub" id="g-assessment-sub">â€”</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Principal Disbursed</div>
      <div class="kpi-val" id="g-principal">â€”</div>
      <div class="kpi-sub" id="g-principal-sub">â€”</div>
    </div>
    <div class="kpi" style="border-top:3px solid #1c5c38">
      <div class="kpi-label">Total Revenue</div>
      <div class="kpi-val" id="g-revenue" style="color:#1c5c38">â€”</div>
      <div class="kpi-sub" id="g-revenue-sub">â€”</div>
    </div>
    <div class="kpi" style="border-top:3px solid var(--amber)">
      <div class="kpi-label">Avg PAR 30</div>
      <div class="kpi-val" id="g-par30-avg" style="color:var(--amber)">â€”</div>
      <div class="kpi-sub" id="g-par30-avg-sub">Average</div>
    </div>
    <div class="kpi" style="border-top:3px solid var(--amber)">
      <div class="kpi-label">Avg Chronic Rate</div>
      <div class="kpi-val" id="g-chronic-avg" style="color:var(--amber)">â€”</div>
      <div class="kpi-sub">Average</div>
    </div>
  </div>

  <!-- DISBURSEMENT -->
  <div class="section-label">Disbursement</div>
  <div class="two-col">
    <div class="card">
      <div class="card-title">Principal Disbursed by Country</div>
      <div class="card-sub" id="g-disb-sub">â€”</div>
      <div class="hbar-chart" id="g-principal-bars"></div>
    </div>
    <div class="card">
      <div class="card-title">Average Loan Size by Country</div>
      <div class="card-sub" id="g-avgloan-sub">MTD Â· Principal Ã· loans disbursed Â· USD</div>
      <div class="hbar-chart" id="g-avgloan-bars"></div>
      <div class="group-avg-box">
        <div>
          <div class="group-avg-label">Group Average</div>
          
        </div>
        <div class="group-avg-val" id="g-avgloan-avg">â€”</div>
      </div>
    </div>
  </div>

  <!-- REVENUE + ASSESSMENT EFFICIENCY -->
  <div class="section-label">Revenue &amp; Pipeline</div>
  <div class="two-col">
    <div class="card">
      <div class="card-title">Total Revenue by Country</div>
      <div class="card-sub" id="g-rev-sub">â€”</div>
      <div class="hbar-chart" id="g-rev-bars"></div>
    </div>
    <div class="card">
      <div class="card-title">Assessment Efficiency by Country</div>
      <div class="card-sub" id="g-assessment-sub2">â€”</div>
      <div class="hbar-chart" id="g-assessment-bars"></div>
      <div class="group-avg-box">
        <div>
          <div class="group-avg-label">Group Average</div>
        </div>
        <div class="group-avg-val" id="g-assessment-avg">â€”</div>
      </div>
    </div>
  </div>

  <!-- DEFAULT METRICS -->
  <div class="section-label">Default Metrics</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card">
      <div class="card-title">PAR 30 &amp; Chronic Rate by Country</div>
      <div class="card-sub" id="g-defaults-sub">As at report date &nbsp;Â·&nbsp; Scale 0â€“30%</div>
      <div class="threshold-legend">
        <span><span class="swatch" style="background:#1c5c38"></span> â‰¤5% Good</span>
        <span><span class="swatch" style="background:var(--amber)"></span> 5â€“10% Watch</span>
        <span><span class="swatch" style="background:var(--red)"></span> &gt;10% Alert</span>
      </div>
      <div id="g-defaults-blocks"></div>
    </div>
  </div>

  <div class="footer-note">
    <span>Oya Microcredit &nbsp;Â·&nbsp; Group Dashboard &nbsp;Â·&nbsp; All figures in USD</span>
    <span>Loan term: 84 days / 12 weekly instalments &nbsp;Â·&nbsp; Chronic threshold: 50 days post-expiry</span>
  </div>
</main>
</div>

<script>
const SHEET_ID = '1y0klKJTbTeStl2z9iLtBZFcKRNoDJ-WAzw7XabfVCGU';

const COUNTRIES = {
  TZ: { name:'Tanzania',    flag:'ðŸ‡¹ðŸ‡¿', color:'#1c5c38', currency:'TZS' },
  KE: { name:'Kenya',       flag:'ðŸ‡°ðŸ‡ª', color:'#1a5276', currency:'KES' },
  UG: { name:'Uganda',      flag:'ðŸ‡ºðŸ‡¬', color:'#6e2c00', currency:'UGX' },
  SL: { name:'Sierra Leone',flag:'ðŸ‡¸ðŸ‡±', color:'#1b5e20', currency:'NLE' },
  NG: { name:'Nigeria',     flag:'ðŸ‡³ðŸ‡¬', color:'#4a235a', currency:'NGN' },
};
const COUNTRY_ORDER = ['TZ','KE','UG','SL','NG'];

let currentCountry = 'TZ';
let currentView = 'mtd';
let reportDate = new Date('2026-02-25');
let liveData = {};
let allRows = {};  // stores all result rows per country for date switching

function fmt(n, d=0) {
  if (n==null||isNaN(n)) return 'â€”';
  return Number(n).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function fmtUSD(n) {
  if (n==null||isNaN(n)) return 'â€”';
  if (Math.abs(n)>=1e6) return '$'+(n/1e6).toFixed(2)+'M';
  if (Math.abs(n)>=1e3) return '$'+(n/1e3).toFixed(0)+'K';
  return '$'+fmt(n);
}
function fmtPct(n,d=1) {
  if (n==null||isNaN(n)) return 'â€”';
  return Number(n).toFixed(d)+'%';
}
function chg(curr,prior,isRate=false) {
  if (!curr||!prior||prior===0) return '';
  const diff=curr-prior, pct=diff/prior*100;
  const color=diff>=0?'#1c5c38':'#9b2b1a', sign=diff>=0?'+':'';
  if (isRate) return `<span style="color:${color}">${sign}${Math.abs(diff).toFixed(1)}pp</span>`;
  return `<span style="color:${color}">${sign}${pct.toFixed(1)}%</span>`;
}
function setText(id,val) { const el=document.getElementById(id); if(el) el.innerHTML=val; }
function setStyle(id,prop,val) { const el=document.getElementById(id); if(el) el.style[prop]=val; }

function rateColor(rate) {
  if (!rate||isNaN(rate)) return 'var(--amber)';
  return rate<=5?'#1c5c38':rate<=10?'var(--amber)':'#9b2b1a';
}

function setCountryColor(color) {
  document.documentElement.style.setProperty('--country-color', color);
  document.getElementById('topbar').style.background = color;
  // Update revenue KPI border
  const revKpi = document.querySelector('#kpi-revenue').closest('.kpi');
  if (revKpi) revKpi.style.borderTopColor = color;
  const revTotal = document.querySelector('#rev-total').closest('.kpi');
  if (revTotal) revTotal.style.borderTopColor = color;
}



function populateDateDropdown() {
  const sel = document.getElementById('report-date-input');
  if (!sel) return;

  // Collect all unique dates across all loaded countries
  const dateSet = new Set();
  COUNTRY_ORDER.forEach(cc => {
    if (!allRows[cc]) return;
    allRows[cc].forEach(row => {
      if (row.report_date) dateSet.add(row.report_date);
    });
  });

  if (dateSet.size === 0) return;

  // Sort descending
  const dates = Array.from(dateSet).sort((a, b) => new Date(b) - new Date(a));

  // Rebuild options
  const current = sel.value;
  sel.innerHTML = dates.map(d => `<option value="${d}"${d===current?' selected':''}>${d}</option>`).join('');

  // Default to latest
  if (!current || !dateSet.has(current)) {
    sel.value = dates[0];
    onDateChange(dates[0]);
  }
}

function onDateChange(dateStr) {
  // Reload all countries for this date
  COUNTRY_ORDER.forEach(code => {
    if (allRows[code]) {
      const row = allRows[code].find(r => r.report_date === dateStr);
      if (row) {
        liveData[code] = row;
      }
    }
  });
  reportDate = new Date(dateStr + 'T00:00:00');
  if (currentCountry === 'GROUP') renderConsolidated();
  else if (liveData[currentCountry]) renderCountry(liveData[currentCountry]);
}

async function loadCountryData(code) {
  const sheet = code + '_Results';
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheet}`;
  try {
    const res = await fetch(url);
    const text = await res.text();
    const start = text.indexOf('{'), end = text.lastIndexOf('}');
    const json = JSON.parse(text.substring(start, end+1));
    const cols = json.table.cols.map(c => c.label);
    const rows = json.table.rows;
    if (!rows||rows.length===0) return;
    // Parse all rows and normalize dates
    const parsedRows = rows.map(r => {
      const row = {};
      cols.forEach((col,i) => {
        const cell = r.c[i];
        row[col] = cell ? (cell.v!==null?cell.v:'') : '';
      });
      // Normalize report_date
      if (row.report_date && typeof row.report_date==='string' && row.report_date.startsWith('Date(')) {
        const parts = row.report_date.replace('Date(','').replace(')','').split(',').map(Number);
        const d = new Date(parts[0], parts[1], parts[2]);
        row.report_date = formatDate(d);
      } else if (row.report_date) {
        // Parse as local time to avoid UTC timezone shift
        const parts = String(row.report_date).split('-');
        if (parts.length === 3) {
          row.report_date = formatDate(new Date(parts[0], parts[1]-1, parts[2]));
        } else {
          row.report_date = formatDate(new Date(row.report_date));
        }
      }
      return row;
    });

    allRows[code] = parsedRows;

    // Default to latest row
    const lastRow = parsedRows[parsedRows.length - 1];
    liveData[code] = lastRow;
    // reportDate set via onDateChange/populateDateDropdown

    if (currentCountry===code) renderCountry(lastRow);
    if (currentCountry==='GROUP') renderConsolidated();

    populateDateDropdown();

    const loaded = COUNTRY_ORDER.filter(c=>liveData[c]).length;
    document.getElementById('data-source-note').textContent = `Live data Â· ${loaded}/5 loaded Â· ${new Date().toLocaleTimeString()}`;
  } catch(e) {
    console.error('Failed to load '+code+':', e);
    document.getElementById('data-source-note').textContent = 'Data load failed for '+code;
  }
}

function switchCountry(code) {
  currentCountry = code;

  // Update nav tabs
  ['group','tz','ke','ug','sl','ng'].forEach(c => {
    const el = document.getElementById('nav-'+c);
    if (el) el.classList.toggle('active', c===code.toLowerCase());
  });

  if (code === 'GROUP') {
    document.getElementById('country-view').style.display = 'none';
    document.getElementById('consolidated-view').style.display = 'block';
    setCountryColor('#1c5c38');
    document.getElementById('country-tag').textContent = 'Group Overview';
    document.getElementById('hdr-rate').textContent = 'All figures in USD';
    document.getElementById('hdr-date').textContent = Object.values(liveData).length > 0 ? (Object.values(liveData)[0].report_date || 'Feb 25, 2026') : 'Feb 25, 2026';
    renderConsolidated();
    return;
  }

  document.getElementById('country-view').style.display = 'block';
  document.getElementById('consolidated-view').style.display = 'none';

  const cfg = COUNTRIES[code];
  setCountryColor(cfg.color);
  document.getElementById('country-tag').textContent = cfg.flag + ' ' + cfg.name;
  setText('footer-left', `Oya Microcredit &nbsp;Â·&nbsp; ${cfg.name} &nbsp;Â·&nbsp; Proviso Cloud &nbsp;Â·&nbsp; Report totals`);

  if (liveData[code]) {
    renderCountry(liveData[code]);
  } else {
    loadCountryData(code);
  }
}

function renderConsolidated() {
  const v = currentView;
  const viewName = v==='week'?'Week':v.toUpperCase();
  const lbl = getDateLabels(v);

  let totalApps=0, totalApprovals=0, totalDisb=0, totalPrincipal=0, totalRevenue=0;
  let priorApps=0, priorRevenue=0, priorPrincipal=0;
  let par30Sum=0, chronicSum=0, par30Count=0, chronicCount=0;

  COUNTRY_ORDER.forEach(cc => {
    const r = liveData[cc];
    if (!r) return;
    if (v==='mtd') {
      totalApps += parseFloat(r.mtd_apps)||0;
      totalApprovals += parseFloat(r.mtd_approvals)||0;
      totalDisb += parseFloat(r.mtd_disbursements)||0;
      totalPrincipal += parseFloat(r.mtd_principal_usd)||0;
      totalRevenue += parseFloat(r.mtd_revenue_usd)||0;
      priorApps += parseFloat(r.prior_mtd_apps)||0;
      priorRevenue += parseFloat(r.prior_mtd_revenue_usd)||0;
      priorPrincipal += parseFloat(r.prior_mtd_principal_usd)||0;
    } else if (v==='ytd') {
      totalApps += parseFloat(r.ytd_apps)||0;
      totalApprovals += parseFloat(r.ytd_approvals)||0;
      totalDisb += parseFloat(r.ytd_disbursements)||0;
      totalPrincipal += parseFloat(r.ytd_principal_usd)||0;
      totalRevenue += parseFloat(r.ytd_revenue_usd)||0;
    } else {
      totalApps += parseFloat(r.week_apps)||0;
      totalApprovals += parseFloat(r.week_approvals)||0;
      totalDisb += parseFloat(r.week_disbursements)||0;
      totalPrincipal += parseFloat(r.week_principal_usd)||0;
      totalRevenue += parseFloat(r.week_revenue_usd)||0;
      priorApps += parseFloat(r.prior_week_apps)||0;
      priorRevenue += parseFloat(r.prior_week_revenue_usd)||0;
    }
    const p30 = parseFloat(r.par30_rate); if (!isNaN(p30)) { par30Sum+=p30; par30Count++; }
    const ch = parseFloat(r.chronic_rate); if (!isNaN(ch)) { chronicSum+=ch; chronicCount++; }
  });

  const approvalRate = totalApps>0?totalApprovals/totalApps*100:0;
  const disbRate = totalApps>0?totalDisb/totalApps*100:0;

  // Weighted averages using denominator cohort sizes
  let par30WNum=0, par30WDenom=0, chWNum=0, chWDenom=0;
  COUNTRY_ORDER.forEach(cc => {
    const r = liveData[cc];
    if (!r) return;
    const p30 = parseFloat(r.par30_rate), p30d = parseFloat(r.par30_denominator_usd);
    const ch  = parseFloat(r.chronic_rate), chd  = parseFloat(r.chronic_denominator_usd);
    if (!isNaN(p30) && !isNaN(p30d) && p30d>0) { par30WNum += p30*p30d; par30WDenom += p30d; }
    if (!isNaN(ch)  && !isNaN(chd)  && chd>0)  { chWNum   += ch*chd;   chWDenom   += chd;   }
  });
  const avgPar30   = par30WDenom>0 ? par30WNum/par30WDenom : 0;
  const avgChronic = chWDenom>0    ? chWNum/chWDenom       : 0;
  const loaded = COUNTRY_ORDER.filter(cc=>liveData[cc]).length;

  setText('g-section-label', `Group Totals â€” ${loaded}/5 countries loaded`);
  setText('g-apps', fmt(totalApps));
  setText('g-apps-sub', priorApps>0?'vs '+fmt(priorApps)+' prior '+viewName+' &nbsp;Â·&nbsp; '+chg(totalApps,priorApps):'All countries');
  setText('g-assessment', fmtPct(approvalRate));
  setText('g-assessment-sub', fmt(totalApprovals)+' approvals / '+fmt(totalApps)+' applications');
  setText('g-principal', fmtUSD(totalPrincipal));
  setText('g-principal-sub', priorPrincipal>0?'vs '+fmtUSD(priorPrincipal)+' prior '+viewName+' &nbsp;Â·&nbsp; '+chg(totalPrincipal,priorPrincipal):'All countries');
  setText('g-revenue', fmtUSD(totalRevenue));
  setText('g-revenue-sub', priorRevenue>0?'vs '+fmtUSD(priorRevenue)+' prior '+viewName+' &nbsp;Â·&nbsp; '+chg(totalRevenue,priorRevenue):'All countries');

  const p30color = rateColor(avgPar30);
  const chcolor = rateColor(avgChronic);
  setText('g-par30-avg', fmtPct(avgPar30));
  document.getElementById('g-par30-avg').style.color = p30color;
  setText('g-par30-avg-sub', 'Average');
  setText('g-chronic-avg', fmtPct(avgChronic));
  document.getElementById('g-chronic-avg').style.color = chcolor;

  setText('g-disb-sub', `${lbl.current} (${viewName})`);
  setText('g-avgloan-sub', `${viewName} Â· Principal Ã· loans disbursed Â· USD`);
  setText('g-assessment-sub2', `${lbl.current} (${viewName}) Â· Approvals Ã· applications Â· scale 0â€“100%`);
  setText('g-rev-sub', `${lbl.current} (${viewName})`);
  setText('g-defaults-sub', `As at report date &nbsp;Â·&nbsp; Scale 0â€“30%`);

  // Avg loan size bars (sorted descending)
  const avgData = COUNTRY_ORDER.map(cc => {
    const r = liveData[cc];
    const prin = r ? parseFloat(v==='mtd'?r.mtd_principal_usd:v==='ytd'?r.ytd_principal_usd:r.week_principal_usd)||0 : 0;
    const disb = r ? parseFloat(v==='mtd'?r.mtd_disbursements:v==='ytd'?r.ytd_disbursements:r.week_disbursements)||0 : 0;
    const avg = disb>0 ? prin/disb : 0;
    return { cc, name:COUNTRIES[cc].name, flag:COUNTRIES[cc].flag, color:COUNTRIES[cc].color, avg, disb, prin };
  }).filter(x=>x.avg>0).sort((a,b)=>b.avg-a.avg);
  const maxAvg = Math.max(...avgData.map(x=>x.avg),1);
  const totalDisbW = avgData.reduce((s,x)=>s+x.disb,0);
  const groupAvgLoan = totalDisbW>0 ? avgData.reduce((s,x)=>s+x.avg*x.disb,0)/totalDisbW : 0;
  document.getElementById('g-avgloan-bars').innerHTML = avgData.map(x=>`
    <div class="hbar-row">
      <div class="hbar-header"><div class="hbar-country">${x.flag} ${x.name}</div><div class="hbar-val" style="color:${x.color}">$${fmt(x.avg)}</div></div>
      <div class="hbar-track"><div class="hbar-fill" style="width:${x.avg/maxAvg*100}%;background:${x.color}"></div></div>
    </div>`).join('');
  setText('g-avgloan-avg', '$'+fmt(groupAvgLoan));

  // Approval efficiency bars (sorted descending)
  const aprData = COUNTRY_ORDER.map(cc => {
    const r = liveData[cc];
    const apps = r ? parseFloat(v==='mtd'?r.mtd_apps:v==='ytd'?r.ytd_apps:r.week_apps)||0 : 0;
    const aprs = r ? parseFloat(v==='mtd'?r.mtd_approvals:v==='ytd'?r.ytd_approvals:r.week_approvals)||0 : 0;
    const rate = apps>0 ? aprs/apps*100 : 0;
    return { cc, name:COUNTRIES[cc].name, flag:COUNTRIES[cc].flag, color:COUNTRIES[cc].color, rate, apps, aprs };
  }).sort((a,b)=>b.rate-a.rate);
  document.getElementById('g-assessment-bars').innerHTML = aprData.map(x=>`
    <div class="hbar-row">
      <div class="hbar-header"><div class="hbar-country">${x.flag} ${x.name}</div><div class="hbar-val" style="color:${x.color}">${fmtPct(x.rate)}</div></div>
      <div class="hbar-track"><div class="hbar-fill" style="width:${Math.min(100,x.rate)}%;background:${x.color}"></div></div>
    </div>`).join('');
  setText('g-assessment-avg', fmtPct(approvalRate));

  // Principal bars
  const pData = COUNTRY_ORDER.map(cc => {
    const r = liveData[cc];
    const val = r ? (parseFloat(v==='mtd'?r.mtd_principal_usd:v==='ytd'?r.ytd_principal_usd:r.week_principal_usd)||0) : 0;
    return { cc, name:COUNTRIES[cc].name, flag:COUNTRIES[cc].flag, color:COUNTRIES[cc].color, val };
  }).sort((a,b)=>b.val-a.val);
  const maxP = Math.max(...pData.map(x=>x.val),1);
  document.getElementById('g-principal-bars').innerHTML = pData.map(x=>`
    <div class="hbar-row">
      <div class="hbar-header"><div class="hbar-country">${x.flag} ${x.name}</div><div class="hbar-val" style="color:${x.color}">${x.val?fmtUSD(x.val):'â€”'}</div></div>
      <div class="hbar-track"><div class="hbar-fill" style="width:${x.val/maxP*100}%;background:${x.color}"></div></div>
    </div>`).join('');

  // Revenue bars
  const rData = COUNTRY_ORDER.map(cc => {
    const r = liveData[cc];
    const val = r ? (parseFloat(v==='mtd'?r.mtd_revenue_usd:v==='ytd'?r.ytd_revenue_usd:r.week_revenue_usd)||0) : 0;
    return { cc, name:COUNTRIES[cc].name, flag:COUNTRIES[cc].flag, color:COUNTRIES[cc].color, val };
  }).sort((a,b)=>b.val-a.val);
  const maxR = Math.max(...rData.map(x=>x.val),1);
  document.getElementById('g-rev-bars').innerHTML = rData.map(x=>`
    <div class="hbar-row">
      <div class="hbar-header"><div class="hbar-country">${x.flag} ${x.name}</div><div class="hbar-val" style="color:${x.color}">${x.val?fmtUSD(x.val):'â€”'}</div></div>
      <div class="hbar-track"><div class="hbar-fill" style="width:${x.val/maxR*100}%;background:${x.color}"></div></div>
    </div>`).join('');

  // PAR30 + Chronic paired gauges per country
  const defaultsData = COUNTRY_ORDER.map(cc => {
    const r = liveData[cc];
    const p30 = r ? parseFloat(r.par30_rate) : null;
    return { cc, p30 };
  }).sort((a,b) => {
    if (a.p30===null||isNaN(a.p30)) return 1;
    if (b.p30===null||isNaN(b.p30)) return -1;
    return a.p30 - b.p30;
  });
  document.getElementById('g-defaults-blocks').innerHTML = defaultsData.map(cc => cc.cc).map(cc => {
    const r = liveData[cc];
    const p30 = r?parseFloat(r.par30_rate):null;
    const ch = r?parseFloat(r.chronic_rate):null;
    const p30c = rateColor(p30); const chc = rateColor(ch);
    return `<div class="gauge-country-block">
      <div class="gauge-country-name">${COUNTRIES[cc].flag} ${COUNTRIES[cc].name}</div>
      <div class="gauge-pair">
        <div class="gauge-item" style="flex:1">
          <div class="gauge-header"><span class="gauge-lbl">PAR 30</span><span class="gauge-pct-sm" style="color:${p30c}">${p30!=null?fmtPct(p30):'â€”'}</span></div>
          <div class="gauge-track"><div class="gauge-fill" style="width:${p30!=null?Math.min(100,p30/30*100):0}%;background:${p30c}"></div></div>
        </div>
        <div class="gauge-item" style="flex:1">
          <div class="gauge-header"><span class="gauge-lbl">Chronic</span><span class="gauge-pct-sm" style="color:${chc}">${ch!=null?fmtPct(ch):'â€”'}</span></div>
          <div class="gauge-track"><div class="gauge-fill" style="width:${ch!=null?Math.min(100,ch/30*100):0}%;background:${chc}"></div></div>
        </div>
      </div>
    </div>`;
  }).join('');
}
function renderCountry(r) {
  const cfg = COUNTRIES[currentCountry];
  const ex = parseFloat(r.exchange_rate)||2640;
  const exLabel = cfg.currency + ' ' + fmt(ex);

  // Update header
  setText('hdr-date', r.report_date||'â€”');
  setText('hdr-rate', '1 USD = ' + exLabel);

  // Update date dropdown â€” populate with available dates from all loaded results
  populateDateDropdown();

  // PAR30 and chronic (always same regardless of period)
  const par30 = parseFloat(r.par30_rate);
  const chronic = parseFloat(r.chronic_rate);
  const p30color = rateColor(par30);
  const chrcolor = rateColor(chronic);
  setText('kpi-par30', fmtPct(par30));
  setStyle('kpi-par30','color',p30color);
  setText('kpi-par30-sub', 'As at '+r.report_date);
  setText('kpi-chronic', fmtPct(chronic));
  setStyle('kpi-chronic','color',chrcolor);
  setText('g-par30', fmtPct(par30));
  document.getElementById('g-par30').style.color = p30color;
  setStyle('g-par30-bar','width', Math.min(100, par30/30*100)+'%');
  setStyle('g-par30-bar','background', p30color);
  setText('g-chronic', fmtPct(chronic));
  document.getElementById('g-chronic').style.color = chrcolor;
  setStyle('g-chronic-bar','width', Math.min(100, chronic/30*100)+'%');
  setStyle('g-chronic-bar','background', chrcolor);

  setView(currentView);
}

function setView(v) {
  currentView = v;
  if (currentCountry==='GROUP') { ['week','mtd','ytd'].forEach(k=>{ document.getElementById('btn-'+k).classList.toggle('active',k===v); }); renderConsolidated(); return; }
  ['week','mtd','ytd'].forEach(k => {
    document.getElementById('btn-'+k).classList.toggle('active', k===v);
  });

  const r = liveData[currentCountry];
  if (!r) return;

  const cfg = COUNTRIES[currentCountry];
  const ex = parseFloat(r.exchange_rate)||2640;
  const exLabel = cfg.currency + ' ' + fmt(ex);
  const lbl = getDateLabels(v);
  const viewName = v==='week'?'Week':v.toUpperCase();

  setText('period-label', `Period: <strong>${lbl.current} (${viewName})</strong> &nbsp;Â·&nbsp; Prior: ${lbl.prior} &nbsp;Â·&nbsp; Defaults as at ${r.report_date}`);

  if (v==='mtd') {
    setText('kpi-apps', fmt(r.mtd_apps));
    setText('kpi-apps-sub', 'vs '+fmt(r.prior_mtd_apps)+' prior MTD &nbsp;Â·&nbsp; '+chg(r.mtd_apps, r.prior_mtd_apps));
    setText('kpi-approval', fmtPct(r.mtd_approval_rate));
    setText('kpi-approval-sub', fmt(r.mtd_approvals)+' approvals / '+fmt(r.mtd_apps)+' applications');
    setText('kpi-principal', fmtUSD(r.mtd_principal_usd));
    setText('kpi-principal-sub', 'vs '+fmtUSD(r.prior_mtd_principal_usd)+' prior MTD &nbsp;Â·&nbsp; '+chg(r.mtd_principal_usd, r.prior_mtd_principal_usd));
    setText('kpi-revenue', fmtUSD(r.mtd_revenue_usd));
    setText('kpi-revenue-sub', 'vs '+fmtUSD(r.prior_mtd_revenue_usd)+' prior MTD &nbsp;Â·&nbsp; '+chg(r.mtd_revenue_usd, r.prior_mtd_revenue_usd));
    setText('rev-interest', '$'+fmt(r.mtd_interest_usd));
    setText('rev-interest-sub', 'vs $'+fmt(r.prior_mtd_interest_usd)+' prior MTD &nbsp;Â·&nbsp; '+chg(r.mtd_interest_usd, r.prior_mtd_interest_usd));
    setText('rev-fees', '$'+fmt(r.mtd_fees_usd));
    setText('rev-fees-sub', 'vs $'+fmt(r.prior_mtd_fees_usd)+' prior MTD &nbsp;Â·&nbsp; '+chg(r.mtd_fees_usd, r.prior_mtd_fees_usd));
    setText('rev-total', '$'+fmt(r.mtd_revenue_usd));
    setText('rev-total-sub', 'vs $'+fmt(r.prior_mtd_revenue_usd)+' prior MTD &nbsp;Â·&nbsp; '+chg(r.mtd_revenue_usd, r.prior_mtd_revenue_usd));
    setText('f-apps-val', fmt(r.mtd_apps));
    setText('f-apr-val', fmt(r.mtd_approvals));
    setText('f-apr-pct', fmtPct(r.mtd_approval_rate));
    setText('f-disb-val', fmt(r.mtd_disbursements));
    const disbPct = r.mtd_apps>0?r.mtd_disbursements/r.mtd_apps*100:0;
    setText('f-disb-pct', fmtPct(disbPct));
    setStyle('f-apr-bar','width', Math.min(100,r.mtd_approval_rate)+'%');
    setStyle('f-disb-bar','width', Math.min(100,disbPct)+'%');
    setText('d-count', fmt(r.mtd_disbursements));
    setText('d-principal', '$'+fmt(r.mtd_principal_usd));
    setText('d-interest', '$'+fmt(r.mtd_interest_usd));
    setText('d-pi', '$'+fmt((+r.mtd_principal_usd||0)+(+r.mtd_interest_usd||0)));
    setText('d-fees', '$'+fmt(r.mtd_fees_usd));
    setText('d-avg', '$'+fmt(r.mtd_disbursements>0?r.mtd_principal_usd/r.mtd_disbursements:0));
    setText('d-rev', '$'+fmt((+r.mtd_principal_usd||0)+(+r.mtd_interest_usd||0)+(+r.mtd_fees_usd||0)));
    setText('f-sub', `Report totals &nbsp;Â·&nbsp; ${lbl.current} (MTD)`);
    setText('disb-sub', `${lbl.current} (MTD) &nbsp;Â·&nbsp; USD values at ${exLabel}`);
  } else if (v==='ytd') {
    setText('kpi-apps', fmt(r.ytd_apps));
    setText('kpi-apps-sub', 'Jan 1 â€“ '+r.report_date);
    setText('kpi-approval', fmtPct(r.ytd_approval_rate));
    setText('kpi-approval-sub', fmt(r.ytd_approvals)+' approvals / '+fmt(r.ytd_apps)+' applications');
    setText('kpi-principal', fmtUSD(r.ytd_principal_usd));
    setText('kpi-principal-sub', 'Jan 1 â€“ '+r.report_date);
    setText('kpi-revenue', fmtUSD(r.ytd_revenue_usd));
    setText('kpi-revenue-sub', 'Interest '+fmtUSD(r.ytd_interest_usd)+' + Fees '+fmtUSD(r.ytd_fees_usd));
    setText('rev-interest', '$'+fmt(r.ytd_interest_usd));
    setText('rev-interest-sub', 'Jan 1 â€“ '+r.report_date);
    setText('rev-fees', '$'+fmt(r.ytd_fees_usd));
    setText('rev-fees-sub', 'Jan 1 â€“ '+r.report_date);
    setText('rev-total', '$'+fmt(r.ytd_revenue_usd));
    setText('rev-total-sub', 'Jan 1 â€“ '+r.report_date);
    setText('f-apps-val', fmt(r.ytd_apps));
    setText('f-apr-val', fmt(r.ytd_approvals));
    setText('f-apr-pct', fmtPct(r.ytd_approval_rate));
    setText('f-disb-val', fmt(r.ytd_disbursements));
    const disbPct = r.ytd_apps>0?r.ytd_disbursements/r.ytd_apps*100:0;
    setText('f-disb-pct', fmtPct(disbPct));
    setStyle('f-apr-bar','width', Math.min(100,r.ytd_approval_rate)+'%');
    setStyle('f-disb-bar','width', Math.min(100,disbPct)+'%');
    setText('d-count', fmt(r.ytd_disbursements));
    setText('d-principal', '$'+fmt(r.ytd_principal_usd));
    setText('d-interest', '$'+fmt(r.ytd_interest_usd));
    setText('d-pi', '$'+fmt((+r.ytd_principal_usd||0)+(+r.ytd_interest_usd||0)));
    setText('d-fees', '$'+fmt(r.ytd_fees_usd));
    setText('d-avg', '$'+fmt(r.ytd_disbursements>0?r.ytd_principal_usd/r.ytd_disbursements:0));
    setText('d-rev', '$'+fmt((+r.ytd_principal_usd||0)+(+r.ytd_interest_usd||0)+(+r.ytd_fees_usd||0)));
    setText('f-sub', `Report totals &nbsp;Â·&nbsp; ${lbl.current} (YTD)`);
    setText('disb-sub', `${lbl.current} (YTD) &nbsp;Â·&nbsp; USD values at ${exLabel}`);
  } else { // week
    setText('kpi-apps', fmt(r.week_apps));
    setText('kpi-apps-sub', 'vs '+fmt(r.prior_week_apps)+' prior week &nbsp;Â·&nbsp; '+chg(r.week_apps, r.prior_week_apps));
    setText('kpi-approval', fmtPct(r.week_approval_rate));
    setText('kpi-approval-sub', fmt(r.week_approvals)+' approvals / '+fmt(r.week_apps)+' applications');
    setText('kpi-principal', fmtUSD(r.week_principal_usd));
    setText('kpi-principal-sub', 'vs '+fmtUSD(r.prior_week_principal_usd)+' prior week &nbsp;Â·&nbsp; '+chg(r.week_principal_usd, r.prior_week_principal_usd));
    setText('kpi-revenue', fmtUSD(r.week_revenue_usd));
    setText('kpi-revenue-sub', 'vs '+fmtUSD(r.prior_week_revenue_usd)+' prior week &nbsp;Â·&nbsp; '+chg(r.week_revenue_usd, r.prior_week_revenue_usd));
    setText('rev-interest', '$'+fmt(r.week_interest_usd));
    setText('rev-interest-sub', 'vs $'+fmt(r.prior_week_interest_usd)+' prior week &nbsp;Â·&nbsp; '+chg(r.week_interest_usd, r.prior_week_interest_usd));
    setText('rev-fees', '$'+fmt(r.week_fees_usd));
    setText('rev-fees-sub', 'vs $'+fmt(r.prior_week_fees_usd)+' prior week');
    setText('rev-total', '$'+fmt(r.week_revenue_usd));
    setText('rev-total-sub', 'vs $'+fmt(r.prior_week_revenue_usd)+' prior week &nbsp;Â·&nbsp; '+chg(r.week_revenue_usd, r.prior_week_revenue_usd));
    setText('f-apps-val', fmt(r.week_apps));
    setText('f-apr-val', fmt(r.week_approvals));
    setText('f-apr-pct', fmtPct(r.week_approval_rate));
    setText('f-disb-val', fmt(r.week_disbursements));
    const disbPct = r.week_apps>0?r.week_disbursements/r.week_apps*100:0;
    setText('f-disb-pct', fmtPct(disbPct));
    setStyle('f-apr-bar','width', Math.min(100,r.week_approval_rate||0)+'%');
    setStyle('f-disb-bar','width', Math.min(100,disbPct)+'%');
    setText('d-count', fmt(r.week_disbursements));
    setText('d-principal', '$'+fmt(r.week_principal_usd));
    setText('d-interest', '$'+fmt(r.week_interest_usd));
    setText('d-pi', '$'+fmt((+r.week_principal_usd||0)+(+r.week_interest_usd||0)));
    setText('d-fees', '$'+fmt(r.week_fees_usd));
    setText('d-avg', '$'+fmt(r.week_disbursements>0?r.week_principal_usd/r.week_disbursements:0));
    setText('d-rev', '$'+fmt((+r.week_principal_usd||0)+(+r.week_interest_usd||0)+(+r.week_fees_usd||0)));
    setText('f-sub', `Report totals &nbsp;Â·&nbsp; ${lbl.current} (Week)`);
    setText('disb-sub', `${lbl.current} (Week) &nbsp;Â·&nbsp; USD values at ${exLabel}`);
  }
}

function formatDate(d) { return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }
function formatDateShort(d) { return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}); }

function getDateLabels(view) {
  const rd=reportDate, year=rd.getFullYear(), month=rd.getMonth(), day=rd.getDate();
  if (view==='week') {
    const ws=new Date(rd); ws.setDate(day-6);
    const pws=new Date(ws); pws.setDate(ws.getDate()-7);
    const pwe=new Date(rd); pwe.setDate(day-7);
    return { current:`${formatDateShort(ws)} â€“ ${formatDate(rd)}`, prior:`${formatDateShort(pws)} â€“ ${formatDate(pwe)}` };
  } else if (view==='mtd') {
    const ms=new Date(year,month,1);
    const pms=new Date(year,month-1,1), pme=new Date(year,month-1,day);
    return { current:`${formatDateShort(ms)} â€“ ${formatDate(rd)}`, prior:`${formatDateShort(pms)} â€“ ${formatDate(pme)}` };
  } else {
    return { current:`Jan 1 â€“ ${formatDate(rd)}`, prior:`Jan 1 â€“ ${formatDateShort(rd)} ${year-1}` };
  }
}

window.onload = () => {
  // Show GROUP tab as active immediately
  ['group','tz','ke','ug','sl','ng'].forEach(c => {
    const el = document.getElementById('nav-'+c);
    if (el) el.classList.toggle('active', c==='group');
  });
  document.getElementById('country-view').style.display = 'none';
  document.getElementById('consolidated-view').style.display = 'block';
  setCountryColor('#1c5c38');
  document.getElementById('country-tag').textContent = 'Group Overview';
  document.getElementById('hdr-rate').textContent = 'All figures in USD';
  currentCountry = 'GROUP';

  // Load all countries â€” consolidated re-renders each time one loads
  COUNTRY_ORDER.forEach((code, i) => {
    setTimeout(() => loadCountryData(code), i * 300);
  });
};
</script>
</body>
</html>
